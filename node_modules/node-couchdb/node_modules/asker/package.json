{
  "name": "asker",
  "version": "0.6.2",
  "description": "http.request wrapper with request retries and http.Agent tuning",
  "main": "./lib/asker.js",
  "scripts": {
    "test": "jshint --config .jshintrc lib test && jscs lib test && mocha -u exports -R spec && if [ ! -n \"$NO_COVERAGE\" ]; then istanbul cover _mocha -- -u exports -R dot test; fi"
  },
  "repository": {
    "type": "git",
    "url": "git://github.com/nodules/asker.git"
  },
  "keywords": [
    "http",
    "request",
    "client"
  ],
  "author": {
    "name": "Phillip Kovalev",
    "email": "twilightfeel@gmail.com",
    "url": "https://github.com/kaero"
  },
  "maintainers": [
    {
      "name": "Phillip Kovalev",
      "email": "twilightfeel@gmail.com",
      "url": "https://github.com/kaero"
    }
  ],
  "contributors": [
    {
      "name": "Alexey Rybakov",
      "email": "alexrybakov@yandex.ru",
      "url": "https://github.com/flackus"
    },
    {
      "name": "Ivan Lukashov",
      "email": "webstalk3r@gmail.com",
      "url": "https://github.com/wayx"
    },
    {
      "name": "Anton Kalinin",
      "email": "hurricanebox@gmail.com",
      "url": "https://github.com/antonKalinin"
    }
  ],
  "licenses": [
    {
      "type": "MIT",
      "url": "http://github.com/nodules/asker/raw/master/LICENSE"
    }
  ],
  "readmeFilename": "README.md",
  "dependencies": {
    "terror": "^1.0.0",
    "extend": "2.0.0",
    "contimer": "^1.0.1"
  },
  "devDependencies": {
    "chai": "^1.10.0",
    "formidable": "1.0.x",
    "istanbul": "*",
    "jscs": "1.4.x",
    "jshint": "2.1.x",
    "mocha": "^2.0.1",
    "vow": "0.3.x"
  },
  "engines": {
    "node": ">=0.8.21"
  },
  "readme": "Asker [![NPM version][npm-image]][npm-link] [![Build status][build-image]][build-link]\n=====\n\n[![Dependency status][deps-image]][deps-link]\n[![devDependency status][devdeps-image]][devdeps-link]\n\nAsker is a wrapper for `http.request` method, which incorporates:\n* response deflating using gzip,\n* requests retrying,\n* connection pools tuning.\n\nIf you are looking for a module to fetch 3rd-party web content (pages, RSS, files or something else), don't waste your time and look at the [request](http://npm.im/request) module, because `asker` doesn't support cookies and redirects out of the box.\n\n`Asker`'s main goal is to communicate between frontends and backends that use some kind of [SLA](http://en.wikipedia.org/wiki/Service-level_agreement).\n\n## Quick start\n\n```javascript\nvar ask = require('asker');\n\nask({ host : 'ya.ru' }, function(error, response) {\n    if (error) {\n        return error.log();\n    }\n\n    console.log('Response retrieved in ' + response.meta.time.total + 'ms');\n    console.log('==========\\n', response.data, '\\n==========');\n});\n```\n\n## Options\n\nAll parameters are optional.\n\n* `{String} host=\"localhost\"`\n* `{String} hostname` — the same as the `host`, used for compatibility with results of the `url.parse()`. Have higher priority than the `host`.\n* `{Number} port=80`\n* `{String} path=\"/\"`\n* `{String} protocol=\"http:\"` — `http:` or `https:`\n* `{String} url` — Shorthand alternative for `protocol`, `hostname`, `port` and `path` options\n* `{String} method=\"GET\"`\n* `{Object} headers` — HTTP headers\n* `{Object} query` — Query params\n* `{String} requestId=\"\"` — Request ID, used in log messages\n* `{*} body` — request body. If it's an `Object` — `JSON.stringify` is applied, otherwise it's converted to `String`.\n* `{String} bodyEncoding=\"string\"` — Body encoding method (`string`, `json`, `urlencoded`, `multipart` or self implemented). [More info](#body-encoding).\n* `{Number} maxRetries=0` — Max number of retries allowed for the request\n* `{Function} onretry(reason Error, retryCount Number)` — called when retry happens. By default it does nothing. As an example, you can pass a function that logs a warning.\n* `{Number} timeout=500` — timeout from the moment, when a socket was given by a pool manager.\n* `{Number} queueTimeout=timeout+50` — timeout from the moment, when asker initiated the request. Useful if pool manager failed to provide a socket for any reason.\n* `{Boolean} allowGzip=true` — allows response compression with gzip\n* `{Function} statusFilter` — status codes processing, see [Response status codes processing](#response-status-codes-processing) section for details.\n* `{Object|false} agent` — http.Agent options, see [Connection pools tuning](#connection-pools-tuning) section for details.\n\n## Response format\n\nSuccesful requests will return data and additional information in the following format:\n\n`{Object} response`\n* `{*} data` received data (if response body wasn't provided, `null` is returned)\n* `{Number} statusCode` http status code\n* `{Object} headers` returned http headers (names are lowercased)\n* `{Object} meta` meta information\n    * `{Object} time` request timers\n        * `{Number} network` from socket open until the request completion\n        * `{Number} total` total execution time\n    * `{Object} options` options that you provided when created an `Asker` request\n    * `{Object} retries`\n        * `{Number} used` number of retries used\n        * `{Number} limit` retries limit for a given request\n\n## Response status codes processing\n\nWhen response status code is received, `asker` passes status code through the filter function, which should determine whether this response code is acceptable. And if not, whether is it necessary to retry a request.\n\nThe only filter function argument is `code`:\n* `{Number} code` is a response status code provided by `asker`.\n\nFunction must return an Object with two fields:\n* `{Boolean} accept` — whether to accept response with a given status code;\n* `{Boolean} isRetryAllowed` — whether to retry an unaccepted request.\n\nResult must be returned ASAP, because filter's execution time WILL affect request timeouts.\n\nDefault filter accepts codes `200` and `201` and allows retries for all codes except `400-499`.\n\nLet's make a quick example. Suppose, we want to accept only responses with `200`, `201` and `304` status codes and do not want to retry requests for `4xx`.\n\n```javascript\nvar ask = require('asker');\n\nfunction filter(code) {\n    return {\n        accept : ~[200, 201, 304].indexOf(code),\n        isRetryAllowed : 400 > code || code > 499\n    }\n}\n\nask({ host: 'data-feed.local', statusFilter : filter }, function(error, response) {\n    // @see http://npm.im/terror for details about error codes\n    if (error.code === ask.Error.CODES.UNEXPECTED_STATUS_CODE) {\n        console.log('Response status code is not 200, 201 or 304');\n    }\n\n    // ...\n});\n```\n\n## Body encoding\n\nBody encoder converts `body` to corresponding format and sets `Content-type` header.\n\n### Built-in encoders\n\n* `string` — Used by default. Converts `body` to `String`. Accepts all types.\n* `json` — Applies `JSON.stringify` to the `body`. Accepts all types.\n* `urlencoded` — Converts `body` to query string. Accepts `Object`.\n* `multipart` — Formats `body` according to [multipart/form-data spec](http://www.w3.org/TR/html4/interact/forms.html#h-17.13.4.2). Accepts `Object` (or `Buffer` object).\n* `raw` – Use body as is. Accepts instance of Buffer. Remember to set `content-type` header manually if required.\n\n### Content-type\n\nIf you pass `Buffer` as property value, mime-type `application/octet-stream` will be applied. And property name will be used as file name.\n\nOtherwise, you can pass additional info (mime-type and filename) in parameter's description:\n```javascript\nask({\n    bodyEncoding : 'multipart', // encoder name\n\n    body : {\n        'sample.mp3' : buffer, // an instance of Buffer, \"sample.mp3\" will be used as file name\n\n        image : {\n            filename : 'image.jpg',\n            mime : 'image/jpeg',\n            data : image_buffer // an instance of Buffer\n        }\n    }\n}, function(error, response) {\n    /* ... */\n});\n```\n\nIf you need to send multiple files in single field wrap them in an array.\n```javascript\nask({\n    bodyEncoding : 'multipart',\n\n    body : {\n        images : [\n            'sample.mp3' : buffer,\n            {\n                filename : 'pic.jpg',\n                mime : 'image/jpeg',\n                data : pic_buffer\n            }\n        ]\n    }\n}, function(error, response) {\n    /* ... */\n});\n```\n\n### Exceptions\n\nIf you use body encoder, Asker can throw following errors:\n\n* `BODY_ENCODER_NOT_EXISTS` – unknown `bodyEncoder` has been passed;\n* `BODY_INCORRECT_TYPE` – `body`'s type is not allowed by the encoder.\n\n### Custom encoders\n\nTo implement you own body encoder, you must add an encoding function as the `Asker.bodyEncoders` property. Property name will be used as the encoder name.\n\nExample:\n```javascript\nvar Asker = require('asker');\n\n// encoder name is 'trimText'\nAsker.bodyEncoders.trimText = function(body, setContentType) {\n    // throw error if passed body format is not acceptable for your encoder\n    if (['number', 'string', 'boolean'].indexOf(typeof body) === -1) {\n        throw AskerError.createError(AskerError.CODES.UNEXPECTED_BODY_TYPE, {\n            type : typeof body,\n            expectedTypes : 'Object'\n        });\n    }\n\n    // 'content-type' header will be set to 'text/plain'\n    setContentType('text/plain');\n\n    return String(data).trim();\n};\n```\n\nNote: `setContentType` sets `Content-Type` header only if header was not set before. But you can force overriding by passing `true` as second argument:\n\n```javascript\nAsker.bodyEncoders.trimText = function(body, setContentType) {\n    setContentType('nyan/colorful', true);\n\n    return 'Colorful nyan cat';\n};\n```\n\n## Connection pools tuning\n\n### The problem\n\nAt this point of time (version `0.10` and below) node.js provides a socket pool manager that works as follows:\n\n* by default `globalAgent` is used for all outgoing http requests;\n* each `Agent` instance, including `globalAgent`, has a `maxSockets` property, which you can change;\n* socket limit is set for each unique __host-port pair__, that is served by this particular `Agent`.\n\nThat is sometimes an unwanted behaviour. Let's take an example.\n\nYou have two backends: `backend:3000` and `backend:4000`. First backend is indispensable for the application, but the second one is complementary. E.g., it makes http calls for the advertisements that you show later.\n\nUnder heavy load this additional backend (which is usually less fault-tolerant) may occupy all sockets that OS provides for the whole `node` process, because default pool manager cares only about __host-port__ pairs. `defaultAgent` does not anyhow correct each backend' socket limit according to process limit.\n\n### Solution\n\nHow `Asker` can help you manage this problem? `Asker` can create a custom instance of `http.Agent` for any given backend. And you can set up a `maxSockets` property by calculating each backend priority.\n\n### API\n\n`{Object} agent` `http.Agent` options:\n\n* `{String} name='globalAgent'` unique name for this backend\n* `{Number} maxSockets=1024` socket limit for this backend\n* `{Boolean} persistent=true` either agent would be deleted when it's last socket is removed. You can consider setting it to false, if you create agent's `name` in runtime.\n\n## Error handling\n\nAsker produces errors using [Terror](http://npm.im/terror), so you can setup your own logger and use `error.log()` method for logging.\n\nIf you already use Terror and created a logger for Terror itself, you shouldn't setup it again for AskerError.\n\n`AskerError` class is available via `request('asker').Error` property. So you can, for example, localize error messages or customize it in your own way.\n[npm-image]: https://img.shields.io/npm/v/asker.svg?style=flat\n[npm-link]: https://npmjs.org/package/asker\n[build-image]: https://img.shields.io/travis/nodules/asker.svg?style=flat\n[build-link]: https://travis-ci.org/nodules/asker\n[deps-image]: https://img.shields.io/david/nodules/asker.svg?style=flat\n[deps-link]: https://david-dm.org/nodules/asker\n[devdeps-image]: https://img.shields.io/david/dev/nodules/asker.svg?style=flat\n[devdeps-link]: https://david-dm.org/nodules/asker#info=peerDependencies\n",
  "bugs": {
    "url": "https://github.com/nodules/asker/issues"
  },
  "homepage": "https://github.com/nodules/asker",
  "_id": "asker@0.6.2",
  "dist": {
    "shasum": "e4e2048a9889231f5354248827a154e6ece618c4"
  },
  "_from": "asker@0.6.2",
  "_resolved": "https://registry.npmjs.org/asker/-/asker-0.6.2.tgz"
}
